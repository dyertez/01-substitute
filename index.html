<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดสอนแทน (Offline)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Sarabun for Thai language -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- XLSX for Excel export/import -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .shimmer-button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(100deg, rgba(255, 255, 255, 0) 20%, rgba(255, 255, 255, 0.25) 50%, rgba(255, 255, 255, 0) 80%);
            transform: skewX(-25deg);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            100% {
                left: 150%;
            }
        }
        .aura-button {
            animation: aura-pulse 2.5s infinite;
        }
        @keyframes aura-pulse {
            0% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(22, 163, 74, 0); }
            100% { box-shadow: 0 0 0 0 rgba(22, 163, 74, 0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- The root element where the React app will be mounted -->
    <div id="root"></div>

    <!-- React Component and Rendering Logic -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // --- Inline SVG Icons (Lucide React equivalents) ---
        const IconX = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x">
            <path d="M18 6 6 18" /><path d="M6 6 18 18" />
          </svg>
        );
        const IconXCircle = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-x-circle">
            <circle cx="12" cy="12" r="10" /><path d="m15 9-6 6" /><path d="m9 9 6 6" />
          </svg>
        );
        const IconUserPlus = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucude-user-plus">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-2 4v2" /><circle cx="9" cy="7" r="4" /><line x1="19" x2="19" y1="8" y2="14" /><line x1="16" x2="22" y1="11" y2="11" />
          </svg>
        );
        const IconCheckCircle = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-check-circle">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-8.62" /><path d="M10.5 12.5L14 16l8-8" />
          </svg>
        );
        const IconZap = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-zap">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
          </svg>
        );
        const IconTrash2 = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-trash-2">
            <path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" />
          </svg>
        );
        const IconCalendar = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-calendar">
            <rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" />
          </svg>
        );
        const IconFileDown = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-file-down">
            <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.4L15.6 2.5z" /><path d="M15 2v5a2 2 0 0 0 2 2h5" /><path d="M12 18V12" /><path d="M9 15l3 3 3-3" />
          </svg>
        );
        const IconUpload = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-upload">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" x2="12" y1="3" y2="15" />
          </svg>
        );
        const IconInfo = (props) => (
          <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-info">
            <circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" />
          </svg>
        );
        
        const App = () => {
          // --- State Management ---
          const [teachers, setTeachers] = useState([]);
          const [schedule, setSchedule] = useState({});
          const [absences, setAbsences] = useState([]);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [isImportModalOpen, setIsImportModalOpen] = useState(false);
          const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
          const [isClearConfirmModalOpen, setIsClearConfirmModalOpen] = useState(false);
          const [selectedAbsentSlot, setSelectedAbsentSlot] = useState(null);
          const [message, setMessage] = useState({ type: '', text: '', subText: '', details: [], tab: '' });
          const [selectedDayIndex, setSelectedDayIndex] = useState(0);
          const [presentTeachersViewMode, setPresentTeachersViewMode] = useState('substitutes_first');
          const [isAutoAssigning, setIsAutoAssigning] = useState(false);
          const [isClearing, setIsClearing] = useState(false);
          const [activeTab, setActiveTab] = useState('substitute');
          
          const [selectedTeacherToReportAbsence, setSelectedTeacherToReportAbsence] = useState('');
          const [teacherAbsenceSearchQuery, setTeacherAbsenceSearchQuery] = useState('');
          const [selectedSubstituteId, setSelectedSubstituteId] = useState('');

          const [timetableSearchQuery, setTimetableSearchQuery] = useState('');
          const [selectedTimetableTeacherId, setSelectedTimetableTeacherId] = useState('');
          
          const [importFile, setImportFile] = useState(null);
          const [isImporting, setIsImporting] = useState(false);
          
          const [autoAssignSuccess, setAutoAssignSuccess] = useState(false);
          const [clearDataSuccess, setClearDataSuccess] = useState(false);
          const [importSuccess, setImportSuccess] = useState(false);

          // --- Static Data ---
          const dayNames = ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์'];
          const totalPeriods = 10;
          const periods = Array.from({ length: totalPeriods }, (_, i) => i + 1);
          const classes = ['ม.1/1', 'ม.1/2', 'ม.2/1', 'ม.2/2', 'ม.3/1', 'ม.3/2', 'ม.4/1', 'ม.4/2', 'ม.5/1', 'ม.5/2', 'ม.6/1', 'ม.6/2'];
          const subjects = ['คณิตศาสตร์', 'วิทยาศาสตร์', 'ภาษาไทย', 'สังคมศึกษา', 'ภาษาอังกฤษ', 'พลศึกษา', 'สุขศึกษา', 'คอมพิวเตอร์'];
          const rooms = ['ห้อง 101', 'ห้อง 102', 'ห้อง 103', 'ห้อง 104', 'ห้อง 201', 'ห้อง 202', 'ห้อง 203', 'ห้อง 204', 'ห้อง 301', 'ห้อง 302'];

          const defaultPeriodTimes = [
            '08:30-09:20', '09:20-10:10', '10:10-11:00', '11:00-11:50',
            '11:50-12:40', '12:40-13:30', '13:30-14:20', '14:20-15:10',
            '15:10-16:00', '16:00-16:50'
          ];
          const [currentPeriodTimes, setCurrentPeriodTimes] = useState(defaultPeriodTimes);

          const generateMockSchedule = (teachersData) => {
            const mockSchedule = {};
            const allTeacherIds = teachersData.map(t => t.id);
            allTeacherIds.forEach(id => (mockSchedule[id] = []));

            dayNames.forEach((_, dayIndex) => {
              allTeacherIds.forEach(teacherId => {
                const teacherSubjects = teachersData.find(t => t.id === teacherId).subjectsCanTeach;
                const assignedPeriods = new Set();
                while (assignedPeriods.size < 5) { // Assign 5 periods for 10 total
                  const randomPeriod = Math.floor(Math.random() * totalPeriods);
                  if (!assignedPeriods.has(randomPeriod)) {
                    assignedPeriods.add(randomPeriod);
                    const subject = teacherSubjects[Math.floor(Math.random() * teacherSubjects.length)];
                    const randomClass = classes[Math.floor(Math.random() * classes.length)];
                    const randomRoom = rooms[Math.floor(Math.random() * rooms.length)];
                    mockSchedule[teacherId].push({
                      dayIndex,
                      periodIndex: randomPeriod,
                      class: randomClass,
                      subject,
                      room: randomRoom,
                      time: defaultPeriodTimes[randomPeriod],
                      isAbsent: false,
                      substituteId: null,
                    });
                  }
                }
              });
            });
            return mockSchedule;
          };

          // --- Initial Data Loading ---
          useEffect(() => {
            console.log("Initializing mock data...");
            const mockTeachers = [...Array(30)].map((_, i) => ({
              id: `T${i + 1}`,
              name: `ครู${String.fromCharCode(65 + i)}`,
              subjectsCanTeach: subjects.slice(i % 3, i % 3 + 2),
            }));
            
            const mockSchedule = generateMockSchedule(mockTeachers);
            setTeachers(mockTeachers);
            setSchedule(mockSchedule);
            console.log("Mock data initialized.");
          }, []);

          // --- Helper Functions ---
          const getTeacherName = (id) => teachers.find(t => t.id === id)?.name || 'ไม่ระบุ';

          const getSlot = (teacherId, dayIndex, periodIndex) => {
            const teacherSchedule = schedule[teacherId] || [];
            return teacherSchedule.find(s => s.dayIndex === dayIndex && s.periodIndex === periodIndex);
          };

          const getSlotClass = (teacherId, dayIndex, periodIndex) => {
            const slot = getSlot(teacherId, dayIndex, periodIndex);
            if (!slot) return 'bg-gray-50';
            
            const absence = absences.find(abs => 
              abs.teacherId === teacherId && abs.dayIndex === dayIndex && abs.periodIndex === periodIndex
            );
            
            if (absence && absence.substituteId) return 'bg-green-100 text-green-800 cursor-pointer';
            if (absence && !absence.substituteId) return 'bg-red-100 text-red-800 cursor-pointer';
            
            if(slot.subject === '.') return 'bg-gray-200 text-gray-500';
            return 'bg-white';
          };

          const getAvailableSubstitutes = (absentSlot, currentAbsences) => {
            if (!absentSlot || !schedule) return [];

            const dayIndex = absentSlot.dayIndex;

            const absentTeachersForDay = new Set(
                currentAbsences
                    .filter(abs => abs.dayIndex === dayIndex)
                    .map(abs => abs.teacherId)
            );

            const busyTeachersAtSlot = new Set();
            for (const teacherId in schedule) {
                const teacherSlots = schedule[teacherId] || [];
                const isBusy = teacherSlots.some(slot =>
                    slot.dayIndex === dayIndex &&
                    slot.periodIndex === absentSlot.periodIndex
                );
                if (isBusy) {
                    busyTeachersAtSlot.add(teacherId);
                }
            }

            const alreadyAssignedSubstitutes = new Set();
            currentAbsences.forEach(absence => {
              if (absence.dayIndex === dayIndex &&
                  absence.periodIndex === absentSlot.periodIndex &&
                  absence.substituteId) {
                alreadyAssignedSubstitutes.add(absence.substituteId);
              }
            });

            const allUnavailableTeachers = new Set([
                ...absentTeachersForDay,
                ...busyTeachersAtSlot,
                ...alreadyAssignedSubstitutes,
                absentSlot.teacherId
            ]);

            return teachers.filter(teacher =>
              !allUnavailableTeachers.has(teacher.id)
            );
          };
          
          // --- Event Handlers ---
          const handleToggleAbsence = (teacherId) => {
            if (!teacherId) return;

            const teacherSlots = schedule[teacherId] || [];
            const slotsToReport = teacherSlots.filter(s => s.dayIndex === selectedDayIndex && s.subject !== '.');
            
            if (slotsToReport.length === 0) {
              setMessage({ type: 'error', text: `ไม่พบตารางสอนของ ${getTeacherName(teacherId)} ในวันนี้`, tab: activeTab });
              return;
            }

            const isAbsent = absences.some(abs => abs.teacherId === teacherId && abs.dayIndex === selectedDayIndex);

            if (isAbsent) {
                setAbsences(prev => prev.filter(abs => !(abs.teacherId === teacherId && abs.dayIndex === selectedDayIndex)));
                setMessage({ type: 'success', text: `ยกเลิกการลาหยุดของครู ${getTeacherName(teacherId)} สำเร็จ`, tab: activeTab });
            } else {
                const newAbsences = slotsToReport.map(slot => {
                    const absenceId = `${teacherId}-${slot.dayIndex}-${slot.periodIndex}`;
                    return {
                        id: absenceId,
                        teacherId,
                        ...slot,
                        substituteId: null,
                    };
                });
                setAbsences(prev => [...prev, ...newAbsences]);
                setMessage({ type: 'success', text: `แจ้งการลาหยุดของครู ${getTeacherName(teacherId)} สำเร็จ`, tab: activeTab });
            }
          };
          
          const handleTeacherSelectionChange = (e) => {
            const teacherId = e.target.value;
            if (teacherId) {
              setSelectedTeacherToReportAbsence(teacherId);
              setIsConfirmModalOpen(true);
            }
          };
          
          const handleRemoveAbsence = (teacherId) => {
              setAbsences(prev => prev.filter(abs => !(abs.teacherId === teacherId && abs.dayIndex === selectedDayIndex)));
              setMessage({ type: 'success', text: `ยกเลิกการลาของครู ${getTeacherName(teacherId)} เรียบร้อยแล้ว`, tab: 'substitute' });
          };

          const confirmAbsenceAction = () => {
            handleToggleAbsence(selectedTeacherToReportAbsence);
            setIsConfirmModalOpen(false);
            setSelectedTeacherToReportAbsence('');
            setTeacherAbsenceSearchQuery('');
          };

          const cancelAbsenceAction = () => {
            setIsConfirmModalOpen(false);
            setSelectedTeacherToReportAbsence('');
            setTeacherAbsenceSearchQuery('');
          };
          
          const handleCellClick = (teacherId, dayIndex, periodIndex) => {
            const slot = getSlot(teacherId, dayIndex, periodIndex);
            const absence = absences.find(abs => 
              abs.teacherId === teacherId && abs.dayIndex === dayIndex && abs.periodIndex === periodIndex
            );
            if (slot && absence) { 
              setSelectedAbsentSlot({ ...absence });
              setSelectedSubstituteId(absence.substituteId || ''); 
              setIsModalOpen(true);
            }
          };

          const assignSubstitute = (substituteId) => {
            if (!selectedAbsentSlot || !substituteId) return;
            setAbsences(prev => prev.map(abs => 
                abs.id === selectedAbsentSlot.id ? { ...abs, substituteId: substituteId } : abs
            ));
            setMessage({ type: 'success', text: `มอบหมายครูสอนแทนสำเร็จ: ${getTeacherName(substituteId)} จะมาสอนแทนครู ${getTeacherName(selectedAbsentSlot.teacherId)}`, tab: activeTab });
            setIsModalOpen(false);
          };

          const cancelSubstitute = () => {
            if (!selectedAbsentSlot) return;
            setAbsences(prev => prev.map(abs => 
                abs.id === selectedAbsentSlot.id ? { ...abs, substituteId: null } : abs
            ));
            setMessage({ type: 'success', text: `ยกเลิกครูสอนแทนสำเร็จสำหรับครู ${getTeacherName(selectedAbsentSlot.teacherId)}`, tab: activeTab });
            setIsModalOpen(false);
          };

          const handleClearAllData = () => {
            setAbsences([]);
            setMessage({ type: 'success', text: 'ล้างข้อมูลการลาและการสอนแทนทั้งหมดสำเร็จ', tab: activeTab });
            setIsClearConfirmModalOpen(false);
            setClearDataSuccess(true);
            setTimeout(() => setClearDataSuccess(false), 2000);
          };

          const handleAutoAssignSubstitutes = () => {
              if (isAutoAssigning) return;
              setIsAutoAssigning(true);

              let unassignedSlots = absences
                  .filter(abs => abs.dayIndex === selectedDayIndex && !abs.substituteId)
                  .sort((a, b) => a.periodIndex - b.periodIndex);

              if (unassignedSlots.length === 0) {
                  setMessage({ type: 'info', text: 'ไม่พบคาบเรียนที่ขาดสอนที่ยังไม่ได้จัดครูสอนแทน', tab: activeTab });
                  setIsAutoAssigning(false);
                  return;
              }
              
              let tempAbsences = JSON.parse(JSON.stringify(absences));
              const assignedSubSubjects = {};
              
              tempAbsences.forEach(abs => {
                if (abs.substituteId && abs.dayIndex === selectedDayIndex) {
                  if (!assignedSubSubjects[abs.substituteId]) {
                    assignedSubSubjects[abs.substituteId] = abs.subject;
                  }
                }
              });

              const assignSlot = (slot, localAbsences, ignoreWorkload = false) => {
                  let availableSubs = getAvailableSubstitutes(slot, localAbsences);
                  
                  availableSubs = availableSubs.filter(sub => {
                      const lockedSubject = assignedSubSubjects[sub.id];
                      return !lockedSubject || lockedSubject === slot.subject;
                  });

                  if (availableSubs.length === 0) return null;

                  const dailyWorkload = {};
                  teachers.forEach(teacher => {
                    const scheduledPeriods = (schedule[teacher.id] || []).filter(s => s.dayIndex === selectedDayIndex && s.subject !== '.').length;
                    const substitutePeriods = localAbsences.filter(a => a.substituteId === teacher.id && a.dayIndex === selectedDayIndex).length;
                    dailyWorkload[teacher.id] = scheduledPeriods + substitutePeriods;
                  });

                  if (!ignoreWorkload) {
                    availableSubs.sort((a, b) => (dailyWorkload[a.id] || 0) - (dailyWorkload[b.id] || 0));
                  }
                  
                  return availableSubs[0];
              };

              let stillUnassigned = [];
              for (const slot of unassignedSlots) {
                  const bestSub = assignSlot(slot, tempAbsences);
                  if (bestSub) {
                      const absenceInTemp = tempAbsences.find(a => a.id === slot.id);
                      absenceInTemp.substituteId = bestSub.id;
                      if (!assignedSubSubjects[bestSub.id]) {
                          assignedSubSubjects[bestSub.id] = slot.subject;
                      }
                  } else {
                      stillUnassigned.push(slot);
                  }
              }

              if (stillUnassigned.length > 0) {
                  for (const slot of stillUnassigned) {
                      const bestSub = assignSlot(slot, tempAbsences, true);
                       if (bestSub) {
                          const absenceInTemp = tempAbsences.find(a => a.id === slot.id);
                          absenceInTemp.substituteId = bestSub.id;
                          if (!assignedSubSubjects[bestSub.id]) {
                              assignedSubSubjects[bestSub.id] = slot.subject;
                          }
                      }
                  }
              }
              
              setAbsences(tempAbsences);
              
              setAutoAssignSuccess(true);
              setTimeout(() => setAutoAssignSuccess(false), 2500);

              const remainingUnassignedCount = tempAbsences.filter(abs => abs.dayIndex === selectedDayIndex && !abs.substituteId).length;

              if (remainingUnassignedCount > 0) {
                  setMessage({ type: 'success', text: `[สำเร็จ] จัดสอนแทนอัตโนมัติแล้ว`, subText: `เหลือ ${remainingUnassignedCount} คาบ\nเลือกที่คาบสีแดง เพื่อเลือกครูเข้าสอนแทน`, tab: activeTab });
              } else {
                  setMessage({ type: 'success', text: 'จัดสอนแทนอัตโนมัติ [ สำเร็จ ]', tab: activeTab });
              }
              setIsAutoAssigning(false);
          };

          const handleExportToExcel = () => {
            const allScheduleSlots = Object.values(schedule).flat();
            if (allScheduleSlots.length === 0) {
              setMessage({ type: 'info', text: 'ไม่พบข้อมูลตารางสอนที่จะส่งออก กรุณารอสักครู่เพื่อให้ข้อมูลโหลดสมบูรณ์', tab: activeTab });
              return;
            }

            const csvRows = [];
            const headers = ["รหัสครู", "ชื่อครู", "วัน", "คาบที่", "เวลา", "วิชา", "ห้อง", "ห้องเรียน"];
            csvRows.push(headers.map(h => `"${h}"`).join(','));

            teachers.forEach(teacher => {
              const teacherSchedule = schedule[teacher.id] || [];
              teacherSchedule.sort((a, b) => a.dayIndex - b.dayIndex || a.periodIndex - b.periodIndex);
              
              teacherSchedule.forEach(slot => {
                const row = [
                  `"${teacher.id}"`,
                  `"${teacher.name}"`,
                  `"${dayNames[slot.dayIndex]}"`,
                  `"${slot.periodIndex + 1}"`,
                  `"${slot.time || currentPeriodTimes[slot.periodIndex]}"`,
                  `"${slot.subject}"`,
                  `"${slot.class}"`,
                  `"${slot.room}"`
                ];
                csvRows.push(row.join(','));
              });
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob(['\ufeff', csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', `ตารางสอนครูทั้งหมด-${new Date().toLocaleDateString('th-TH')}.csv`);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              setMessage({ type: 'success', text: 'ส่งออกข้อมูลตารางสอนสำเร็จ!', tab: activeTab });
            } else {
              setMessage({ type: 'error', text: 'เบราว์เซอร์ของคุณไม่รองรับการดาวน์โหลดอัตโนมัติ', tab: activeTab });
            }
          };
          
          const handleFileImport = async (file) => {
            if (!file || isImporting) return;
            
            setIsImporting(true);
            setMessage({ type: '', text: '', subText: '', details: [], tab: 'import' });
            setImportSuccess(false);

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    console.log("Raw data from Excel:", jsonData);

                    const expectedHeaders = ['รหัสครู', 'ชื่อครู', 'วัน', 'คาบที่', 'เวลา', 'วิชา', 'ห้อง', 'ห้องเรียน'];
                    const fileHeaders = jsonData[0];

                    if (!fileHeaders || expectedHeaders.some(header => !fileHeaders.includes(header))) {
                        const errorMessage = 'พบข้อผิดพลาด: ชื่อคอลัมน์ไม่ถูกต้อง กรุณาตรวจสอบให้ตรงกับที่กำหนด (รหัสครู, ชื่อครู, วัน, คาบที่, เวลา, วิชา, ห้อง, ห้องเรียน)';
                        console.error(errorMessage, "Expected:", expectedHeaders, "Got:", fileHeaders);
                        setMessage({ type: 'error', text: errorMessage, details: [], tab: 'import' });
                        setIsImporting(false);
                        return;
                    }
                    const headerMap = Object.fromEntries(expectedHeaders.map(header => [header, fileHeaders.indexOf(header)]));

                    const newTeachersObj = {};
                    const newSchedules = {};
                    const dayMap = dayNames.reduce((acc, day, index) => ({ ...acc, [day]: index }), {});
                    const importedTimesForPeriods = [...defaultPeriodTimes];

                    let importedRowCount = 0;
                    const skippedRowDetails = [];

                    const getSolution = (reason) => {
                        if (reason.includes('แถวว่างเปล่า')) return 'ตรวจสอบให้แน่ใจว่าแถวมีข้อมูลที่จำเป็น';
                        if (reason.includes('ข้อมูลไม่สมบูรณ์')) return 'กรอกข้อมูลให้ครบถ้วนในคอลัมน์ที่ระบุ';
                        if (reason.includes('ชื่อวันไม่ถูกต้อง')) return 'ใช้ชื่อวันเต็ม (จันทร์, อังคาร, พุธ, พฤหัสบดี, ศุกร์)';
                        if (reason.includes('คาบที่')) return `ตรวจสอบให้แน่ใจว่าเป็นตัวเลขระหว่าง 1-${totalPeriods}`;
                        return 'ตรวจสอบข้อมูลในแถวนี้ให้ถูกต้องตามรูปแบบ';
                    };

                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0 || row.every(cell => !cell)) {
                            skippedRowDetails.push({ row: i + 1, reason: 'แถวว่างเปล่า', solution: getSolution('แถวว่างเปล่า') });
                            continue;
                        }

                        const teacherId = (row[headerMap['รหัสครู']] || '').toString().trim();
                        const teacherName = (row[headerMap['ชื่อครู']] || '').toString().trim();
                        const day = (row[headerMap['วัน']] || '').toString().trim();
                        const periodRaw = (row[headerMap['คาบที่']] || '');
                        const period = parseInt(periodRaw);
                        const time = (row[headerMap['เวลา']] || '').toString().trim();
                        const subject = (row[headerMap['วิชา']] || '').toString().trim();
                        const classRoom = (row[headerMap['ห้อง']] || '').toString().trim();
                        const room = (row[headerMap['ห้องเรียน']] || '').toString().trim();

                        let isValidRow = true;
                        const missingFields = [];

                        if (!teacherId) missingFields.push('รหัสครู');
                        if (!teacherName) missingFields.push('ชื่อครู');
                        if (!day) missingFields.push('วัน');
                        if (periodRaw === '' || isNaN(period) || period < 1 || period > totalPeriods) missingFields.push('คาบที่');
                        
                        if (!subject && (classRoom || room)) missingFields.push('วิชา');
                        if (subject !== '.' && (!classRoom || !room)) {
                            if(!classRoom) missingFields.push('ห้อง');
                            if(!room) missingFields.push('ห้องเรียน');
                        }


                        if (missingFields.length > 0) {
                            isValidRow = false;
                            const reason = `ข้อมูลไม่สมบูรณ์ในคอลัมน์: ${missingFields.join(', ')}`;
                            skippedRowDetails.push({ row: i + 1, reason: reason, solution: getSolution(reason) });
                        }
                        
                        if (isValidRow && !dayMap.hasOwnProperty(day)) {
                          isValidRow = false;
                          const reason = `ชื่อวันไม่ถูกต้อง: "${day}"`;
                          skippedRowDetails.push({ row: i + 1, reason: reason, solution: getSolution(reason) });
                        }

                        if (!isValidRow) continue;

                        if(!subject && !classRoom && !room) continue;

                        if (!newTeachersObj[teacherId]) {
                           newTeachersObj[teacherId] = { id: teacherId, name: teacherName, subjectsCanTeach: [] };
                        }
                        if (subject && subject !== '.' && !newTeachersObj[teacherId].subjectsCanTeach.includes(subject)) {
                            newTeachersObj[teacherId].subjectsCanTeach.push(subject);
                        }

                        const dayIndex = dayMap[day];
                        const periodIndex = period - 1;

                        if (!newSchedules[teacherId]) newSchedules[teacherId] = [];
                        newSchedules[teacherId].push({ dayIndex, periodIndex, class: classRoom, subject, room, time });

                        if (time && periodIndex >= 0 && periodIndex < totalPeriods) {
                          importedTimesForPeriods[periodIndex] = time;
                        }
                        importedRowCount++;
                    }
                    
                    let finalMessageText = '';
                    let finalMessageType = 'success';

                    if (importedRowCount > 0) {
                        setTeachers(Object.values(newTeachersObj));
                        setSchedule(newSchedules);
                        setAbsences([]); // Clear old absences
                        setImportSuccess(true);
                        finalMessageText = `นำเข้าข้อมูลตารางสอนใหม่สำเร็จ ${importedRowCount} แถว.`;
                        if (skippedRowDetails.length > 0) {
                            finalMessageText += ` มี ${skippedRowDetails.length} แถวที่ถูกข้าม.`;
                        }
                    } else if (skippedRowDetails.length > 0) {
                        finalMessageText = `นำเข้าข้อมูลตารางสอนสำเร็จ แต่ไม่มีแถวข้อมูลที่ถูกต้องถูกนำเข้า. มี ${skippedRowDetails.length} แถวที่ถูกข้าม.`;
                        finalMessageType = 'error';
                    } else {
                        finalMessageText = 'ไฟล์ที่เลือกไม่มีข้อมูลตารางสอนที่สามารถนำเข้าได้.';
                        finalMessageType = 'info';
                    }

                    setMessage({ type: finalMessageType, text: finalMessageText, details: skippedRowDetails, tab: 'import' });
                    setImportFile(file);
                    setCurrentPeriodTimes(importedTimesForPeriods);
                };

                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error importing file:", error);
                setMessage({ type: 'error', text: 'พบข้อผิดพลาด: ' + error.message, details: [], tab: 'import' });
            } finally {
                setIsImporting(false);
            }
          };

          const handleClearSelectedFile = () => {
            setImportFile(null);
            setMessage({ type: '', text: '', subText: '', details: [], tab: '' });
            const fileInput = document.getElementById('file-upload-modal');
            if (fileInput) fileInput.value = '';
          };

          const handleFinishImport = () => {
              setIsImportModalOpen(false);
              setImportSuccess(false);
              setActiveTab('substitute');
          };

          const handleDownloadSampleFile = async () => {
            const headers = ["รหัสครู", "ชื่อครู", "วัน", "คาบที่", "เวลา", "วิชา", "ห้อง", "ห้องเรียน"];
            const sampleData = [
              ["T001", "ครูสมชาย", "จันทร์", "1", "08:30-09:20", "คณิตศาสตร์", "ม.1/1", "ห้อง 101"],
              ["T002", "ครูสมศรี", "อังคาร", "2", "09:20-10:10", "ภาษาไทย", "ม.2/2", "ห้อง 202"],
              ["T003", "ครูสมศักดิ์", "พุธ", "4", "11:00-11:50", "ลูกเสือ", ".", "."],
              ["T001", "ครูสมชาย", "พฤหัสบดี", "5", "11:50-12:40", "วิทยาศาสตร์", "ม.1/1", "ห้อง 101"],
              ["T002", "ครูสมศรี", "ศุกร์", "7", "13:30-14:20", "พลศึกษา", "ม.3/1", "สนามบาส"]
            ];

          

            const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sample Schedule");

            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });

            const s2ab = (s) => {
              const buf = new ArrayBuffer(s.length);
              const view = new Uint8Array(buf);
              for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
              return buf;
            };

            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', `sample_schedule_import.xlsx`);
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              setMessage({ type: 'success', text: 'ดาวน์โหลดไฟล์ตัวอย่างสำเร็จ!', tab: 'import' });
            } else {
              setMessage({ type: 'error', text: 'เบราว์เซอร์ของคุณไม่รองรับการดาวน์โหลดอัตโนมัติ', tab: 'import' });
            }
          };

          const absentTeacherIds = [...new Set(absences
            .filter(abs => abs.dayIndex === selectedDayIndex)
            .map(abs => abs.teacherId)
          )];

          const absentTeachers = teachers.filter(t => absentTeacherIds.includes(t.id));
          let presentTeachers = teachers.filter(t => !absentTeacherIds.includes(t.id));

          if (presentTeachersViewMode === 'substitutes_first') {
              const substituteTeachers = presentTeachers.filter(teacher =>
                  absences.some(abs => abs.substituteId === teacher.id && abs.dayIndex === selectedDayIndex)
              ).sort((a, b) => a.id.localeCompare(b.id, 'th'));

              const otherTeachers = presentTeachers.filter(teacher =>
                  !absences.some(abs => abs.substituteId === teacher.id && abs.dayIndex === selectedDayIndex)
              ).sort((a, b) => a.id.localeCompare(b.id, 'th'));

              presentTeachers = [...substituteTeachers, ...otherTeachers];
          } else if (presentTeachersViewMode === 'alphabetical') {
              presentTeachers.sort((a, b) => a.id.localeCompare(b.id, 'th'));
          }
          
          const filteredTeachers = useMemo(() => {
              if (!selectedTimetableTeacherId && !timetableSearchQuery) {
                  return teachers.sort((a, b) => a.id.localeCompare(b.id, 'th'));
              }

              let currentTeachers = teachers;

              if (selectedTimetableTeacherId) {
                  currentTeachers = teachers.filter(teacher => teacher.id === selectedTimetableTeacherId);
              } else if (timetableSearchQuery) {
                  currentTeachers = teachers.filter(teacher =>
                      teacher.name.toLowerCase().includes(timetableSearchQuery.toLowerCase()) ||
                      teacher.id.toLowerCase().includes(timetableSearchQuery.toLowerCase())
                  );
              }
              return currentTeachers.sort((a, b) => a.id.localeCompare(b.id, 'th'));
          }, [teachers, selectedTimetableTeacherId, timetableSearchQuery]);

          const substituteSummary = useMemo(() => {
            const flatSummary = absences
                .filter(abs => abs.substituteId) // Only include assigned substitutions
                .map(abs => ({
                    substituteId: abs.substituteId,
                    substituteName: getTeacherName(abs.substituteId),
                    absentTeacherId: abs.teacherId,
                    absentTeacherName: getTeacherName(abs.teacherId),
                    dayIndex: abs.dayIndex,
                    periodIndex: abs.periodIndex,
                    time: abs.time || currentPeriodTimes[abs.periodIndex],
                    subject: abs.subject,
                    class: abs.class,
                    room: abs.room,
                }))
                .sort((a, b) => {
                    // Sort by day, then substitute teacher, then period
                    if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                    const nameA = a.substituteName || '';
                    const nameB = b.substituteName || '';
                    if (nameA.localeCompare(nameB, 'th') !== 0) {
                        return nameA.localeCompare(nameB, 'th');
                    }
                    return a.periodIndex - b.periodIndex;
                });

            return flatSummary;
          }, [absences, teachers, currentPeriodTimes]);

          // Memoize available substitutes to avoid recalculation
          const availableSubstitutes = useMemo(() => {
            if (!selectedAbsentSlot) return [];
            return getAvailableSubstitutes(selectedAbsentSlot, absences);
          }, [selectedAbsentSlot, schedule, absences, teachers]);


          return (
            <div className="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans antialiased text-gray-800">
              <div className="container mx-auto max-w-7xl">
                <header className="mb-8 p-6 bg-white rounded-2xl shadow-xl border-t-4 border-blue-500">
                  <h1 className="text-3xl sm:text-4xl font-bold text-center text-blue-800 mb-2">
                    ระบบจัดสอนแทน (Offline)
                  </h1>
                  <p className="text-center text-gray-400 text-xs mt-2">
                    ข้อมูลจะถูกรีเซ็ตเมื่อปิดหรือรีเฟรชหน้า
                  </p>
                </header>

                <div className="flex bg-white rounded-t-2xl shadow-md overflow-hidden">
                  <button
                    className={`flex-1 py-4 px-6 text-center text-lg font-bold transition-colors duration-200 ${
                      activeTab === 'substitute' ? 'bg-blue-600 text-white shadow-inner' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                    onClick={() => setActiveTab('substitute')}
                  >
                    ระบบจัดสอนแทน
                  </button>
                  <button
                    className={`flex-1 py-4 px-6 text-center text-lg font-bold transition-colors duration-200 ${
                      activeTab === 'full_schedule' ? 'bg-blue-600 text-white shadow-inner' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                    }`}
                    onClick={() => setActiveTab('full_schedule')}
                  >
                    ตารางสอน
                  </button>
                </div>

                <main className="grid grid-cols-1 gap-6 p-6 bg-white rounded-b-2xl shadow-xl">
                  {activeTab === 'substitute' && (
                    <>
                      <section className="bg-gray-50 rounded-2xl p-6 border border-gray-200 shadow-sm relative">
                        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                          <h2 className="text-xl font-semibold text-black flex items-center gap-2">
                            <IconX /> ตารางสอนของครูที่ลา วัน{dayNames[selectedDayIndex]}
                          </h2>
                          <button
                            onClick={() => setIsImportModalOpen(true)}
                            className="absolute top-4 right-4 px-3 py-1.5 rounded-xl bg-yellow-400 text-white font-medium shadow-sm hover:bg-yellow-500 transition-colors duration-200 flex items-center justify-center gap-1 text-sm sm:text-sm"
                          >
                            <IconUpload className="w-4 h-4" />
                            นำเข้าข้อมูล
                          </button>
                        </div>
                        
                        <div className="flex flex-col gap-4 mb-4">
                          <div className="w-full sm:w-1/2 mx-auto">
                            <label htmlFor="day-select" className="block text-sm font-medium text-gray-700 mb-2">เลือกวัน :</label>
                            <div className="flex items-center space-x-1 bg-gray-100 p-1 rounded-xl shadow-inner">
                              {dayNames.map((day, index) => (
                                <button
                                  key={index}
                                  onClick={() => setSelectedDayIndex(index)}
                                  className={`flex-1 px-2 py-1 rounded-xl text-sm font-medium transition-all duration-200 ease-in-out flex-shrink-0
                                    ${selectedDayIndex === index ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-200'}`}
                                >
                                  {day}
                                </button>
                              ))}
                            </div>
                          </div>
                          <div className="flex-grow">
                            <label htmlFor="teacher-select" className="block text-sm font-medium text-gray-700 mb-2">
                              เลือกครูที่ลา :
                            </label>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <div className="flex-1">
                                    <label htmlFor="teacher-select" className="sr-only">เลือกครูที่ลา</label>
                                    <select
                                        id="teacher-select"
                                        value={selectedTeacherToReportAbsence}
                                        onChange={handleTeacherSelectionChange}
                                        className="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm appearance-none"
                                    >
                                        <option value="">--เลือกครู--</option>
                                        {teachers
                                            .filter(teacher => !absentTeacherIds.includes(teacher.id))
                                            .filter(teacher => teacher.name.toLowerCase().includes(teacherAbsenceSearchQuery.toLowerCase()))
                                            .sort((a, b) => a.id.localeCompare(b.id, 'th'))
                                            .map(teacher => (
                                                <option key={teacher.id} value={teacher.id}>
                                                    {teacher.id} - {teacher.name}
                                                </option>
                                            ))}
                                    </select>
                                </div>
                                <div className="flex-1">
                                    <label htmlFor="teacher-absence-search" className="sr-only">ค้นหาชื่อครู</label>
                                    <input
                                        id="teacher-absence-search"
                                        type="text"
                                        placeholder="--พิมพ์ชื่อ--"
                                        value={teacherAbsenceSearchQuery}
                                        onChange={(e) => setTeacherAbsenceSearchQuery(e.target.value)}
                                        className="block w-full px-4 py-2 text-base border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                                <div className="flex flex-col sm:flex-row gap-3">
                                  <button
                                      onClick={handleAutoAssignSubstitutes}
                                      disabled={absentTeachers.length === 0 || isAutoAssigning || autoAssignSuccess}
                                      className={`
                                          flex-1 sm:flex-none px-4 py-2 rounded-xl text-white font-medium shadow-sm transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 relative overflow-hidden w-36
                                          ${autoAssignSuccess 
                                              ? 'bg-blue-500' 
                                              : absentTeachers.length > 0 ? 'bg-green-600 hover:bg-green-700 shimmer-button aura-button' : 'bg-gray-400'
                                          }
                                      `}
                                  >
                                      {autoAssignSuccess ? (
                                          <>
                                              <IconCheckCircle className="w-5 h-5" />
                                              <span>สำเร็จ!</span>
                                          </>
                                      ) : isAutoAssigning ? (
                                          <>
                                              <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                              </svg>
                                              <span>กำลังจัด...</span>
                                          </>
                                      ) : (
                                          <>
                                              <IconZap className="w-5 h-5" />
                                              <span>จัดอัตโนมัติ</span>
                                          </>
                                      )}
                                  </button>
                                  <button
                                      onClick={() => setIsClearConfirmModalOpen(true)}
                                      className={`
                                          flex-1 sm:flex-none px-4 py-2 rounded-xl text-white font-medium shadow-sm transition-colors duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2 w-36
                                          ${clearDataSuccess ? 'bg-emerald-500' : absentTeachers.length > 0 ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400'}
                                      `}
                                      disabled={isClearing || clearDataSuccess || absentTeachers.length === 0}
                                  >
                                      {clearDataSuccess ? (
                                          <>
                                              <IconCheckCircle className="w-5 h-5" />
                                              <span>ล้างแล้ว</span>
                                          </>
                                      ) : isClearing ? (
                                          <>
                                              <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                              </svg>
                                              <span>กำลังล้าง...</span>
                                          </>
                                      ) : (
                                          <>
                                              <IconTrash2 className="w-5 h-5" />
                                              <span>ล้างข้อมูล</span>
                                          </>
                                      )}
                                  </button>
                                </div>
                            </div>
                          </div>
                        </div>

                        {message.text && activeTab === 'substitute' && message.tab === 'substitute' && (
                            <div className={`p-4 rounded-lg shadow mt-6 mb-4 flex flex-col sm:flex-row items-start sm:items-center justify-between animate-fade-in
                              ${message.type === 'success' ? 'bg-green-100 border-l-4 border-green-500 text-green-700' : 
                                message.type === 'error' ? 'bg-red-100 border-l-4 border-red-500 text-red-700' :
                                'bg-blue-100 border-l-4 border-blue-500 text-blue-700'}`}
                              role="alert"
                            >
                              <div className="flex items-start mb-2 sm:mb-0">
                                {message.type === 'success' ? <IconCheckCircle className="h-5 w-5 mr-3 flex-shrink-0" /> : 
                                 message.type === 'error' ? <IconX className="h-5 w-5 mr-3 flex-shrink-0" /> :
                                 <IconInfo className="w-5 h-5 mr-3 flex-shrink-0" />}
                                <div>
                                    <p className="font-medium">{message.text}</p>
                                    {message.subText && (
                                        <div className="text-red-600 mt-1">
                                            {message.subText.split('\n').map((line, index) => (
                                                <p key={index} className={index === 0 ? 'font-bold' : 'font-normal'}>
                                                    {line}
                                                </p>
                                            ))}
                                        </div>
                                    )}
                                </div>
                              </div>
                              <button
                                onClick={() => setMessage({ type: '', text: '', subText: '', tab: '' })}
                                className={`ml-auto sm:ml-4 p-1 rounded-full transition-colors flex-shrink-0
                                  ${message.type === 'success' ? 'hover:bg-green-200 text-green-600' : 
                                    message.type === 'error' ? 'hover:bg-red-200 text-red-600' :
                                    'hover:bg-blue-200 text-blue-600'}`}
                                aria-label="Close message"
                              >
                                <IconX className="h-4 w-4" />
                              </button>
                            </div>
                          )}

                        {absentTeachers.length > 0 && (
                            <div className="mt-6">
                                <div className="overflow-x-auto">
                                <table className="min-w-full table-fixed border-collapse">
                                    <thead>
                                    <tr className="bg-gray-200 text-gray-800 font-bold uppercase text-sm">
                                        <th className="p-3 border border-gray-300 w-[15%]">ชื่อครู</th>
                                        {periods.map(period => (
                                        <th key={period} className="p-3 border border-gray-300 w-[8.5%]">
                                            {period}
                                            <p className="text-xs font-normal text-gray-600 mt-1">{currentPeriodTimes[period - 1]}</p>
                                        </th>
                                        ))}
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {absentTeachers.map(teacher => (
                                        <tr key={teacher.id} className="text-center text-sm even:bg-gray-100">
                                        <td className="p-3 border border-gray-300 font-bold bg-gray-200 text-gray-700 align-middle">
                                            <div className="flex items-center justify-between h-full">
                                                <span>
                                                <p className="text-xs text-gray-500">{teacher.id}</p>
                                                {teacher.name}
                                                </span>
                                                <button 
                                                    onClick={() => handleRemoveAbsence(teacher.id)}
                                                    className="text-red-500 hover:text-red-700 p-1 rounded-full transition-colors"
                                                    title={`ลบการลาของครู ${teacher.name}`}
                                                >
                                                    <IconXCircle className="w-4 h-4" />
                                                </button>
                                            </div>
                                        </td>
                                        {periods.map(periodIndex => {
                                            const slot = getSlot(teacher.id, selectedDayIndex, periodIndex - 1);
                                            if (!slot || slot.subject === '.') return <td key={`${teacher.id}-${periodIndex}`} className={`p-3 border border-gray-200 ${getSlotClass(teacher.id, selectedDayIndex, periodIndex - 1)}`}></td>;

                                            const absence = absences.find(abs => 
                                            abs.teacherId === teacher.id && abs.dayIndex === selectedDayIndex && abs.periodIndex === periodIndex - 1);
                                            
                                            return (
                                            <td
                                                key={`${teacher.id}-${periodIndex}`}
                                                className={`p-3 border border-gray-300 
                                                ${absence && absence.substituteId ? 'bg-green-100 text-green-800' : 
                                                    (absence && !absence.substituteId ? 'bg-red-100 text-red-800' : 'bg-white')} 
                                                cursor-pointer`}
                                                onClick={() => handleCellClick(teacher.id, selectedDayIndex, periodIndex - 1)}
                                            >
                                                <div>
                                                <p className="font-semibold text-xs sm:text-sm">{slot.subject}</p>
                                                <p className="text-[10px] sm:text-xs text-gray-500">{slot.class}</p>
                                                <p className="text-[10px] sm:text-xs text-gray-500">{slot.room}</p>
                                                {absence && absence.substituteId && (
                                                    <div className="text-[10px] text-green-600 font-medium mt-1">
                                                        <p>สอนแทนโดย :</p>
                                                        <p>{absence.substituteId}</p>
                                                        <p>{getTeacherName(absence.substituteId)}</p>
                                                    </div>
                                                )}
                                                </div>
                                            </td>
                                            );
                                        })}
                                        </tr>
                                    ))}
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        )}
                      </section>

                      <section className="bg-white rounded-2xl p-6 overflow-x-auto border border-gray-200 shadow-sm">
                        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4">
                          <h2 className="text-xl font-semibold text-blue-700 flex items-center gap-2">
                            <IconCheckCircle /> ตารางสอนของครูที่ไม่ได้ลา วัน{dayNames[selectedDayIndex]}
                          </h2>
                          <div className="flex items-center space-x-2 bg-gray-100 p-1 rounded-xl shadow-inner">
                            <button
                              onClick={() => setPresentTeachersViewMode('substitutes_first')}
                              className={`px-4 py-1 rounded-xl text-sm font-medium transition-all duration-200 ease-in-out
                                ${presentTeachersViewMode === 'substitutes_first' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-200'}`}
                            >
                              มีสอนแทน
                            </button>
                            <button
                              onClick={() => setPresentTeachersViewMode('alphabetical')}
                              className={`px-4 py-1 rounded-xl text-sm font-medium transition-all duration-200 ease-in-out
                                ${presentTeachersViewMode === 'alphabetical' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 hover:bg-gray-200'}`}
                            >
                              A-Z
                            </button>
                          </div>
                        </div>
                        <div className="overflow-x-auto">
                          <table className="min-w-full table-fixed border-collapse">
                            <thead>
                              <tr className="bg-blue-100 text-blue-800 font-bold uppercase text-sm">
                                <th className="p-3 border border-blue-200 w-[15%]">ชื่อครู</th>
                                {periods.map(period => (
                                  <th key={period} className="p-3 border border-blue-200 w-[8.5%]">
                                    {period}
                                    <p className="text-xs font-normal text-blue-600 mt-1">{currentPeriodTimes[period - 1]}</p>
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody>
                              {presentTeachers.map(teacher => (
                                <tr key={teacher.id} className="text-center text-sm even:bg-gray-50">
                                  <td className="p-3 border border-gray-200 font-bold bg-blue-50 text-blue-700">
                                    <div>
                                        <p className="text-xs text-gray-500">{teacher.id}</p>
                                        <p>{teacher.name}</p>
                                    </div>
                                  </td>
                                  {periods.map(periodIndex => {
                                    const slot = getSlot(teacher.id, selectedDayIndex, periodIndex - 1);
                                    
                                    const substituteSlot = absences.find(abs => 
                                      abs.substituteId === teacher.id && 
                                      abs.dayIndex === selectedDayIndex && 
                                      abs.periodIndex === periodIndex - 1
                                    );

                                    if (substituteSlot) {
                                      return (
                                        <td 
                                          key={`${teacher.id}-${periodIndex}`} 
                                          className={`p-3 border border-blue-200 bg-yellow-100 text-yellow-800 font-medium`}
                                        >
                                            <p className="font-semibold text-xs sm:text-sm">{substituteSlot.subject}</p>
                                            <p className="text-[10px] sm:text-xs text-gray-500">{substituteSlot.class}</p>
                                            <p className="text-[10px] sm:text-xs text-gray-500">{substituteSlot.room}</p>
                                            <div className="text-[10px] text-yellow-800 font-medium mt-1">
                                                <p>ครูที่ลา :</p>
                                                <p className="text-red-600">{substituteSlot.teacherId}</p>
                                                <p className="text-red-600">{getTeacherName(substituteSlot.teacherId)}</p>
                                            </div>
                                        </td>
                                      );
                                    }
                                    
                                    if (!slot) {
                                      return <td key={`${teacher.id}-${periodIndex}`} className="p-3 border border-gray-200 bg-gray-50"></td>;
                                    }
                                    
                                    return (
                                      <td
                                        key={`${teacher.id}-${periodIndex}`}
                                        className={`p-3 border border-gray-200 ${getSlotClass(teacher.id, selectedDayIndex, periodIndex - 1)}`}
                                      >
                                        {slot.subject === '.' ? (
                                            <span>.</span>
                                        ) : (
                                          <div>
                                            <p className="font-semibold text-xs sm:text-sm">{slot.subject}</p>
                                            <p className="text-[10px] sm:text-xs text-gray-500">{slot.class}</p>
                                            <p className="text-[10px] sm:text-xs text-gray-500">{slot.room}</p>
                                          </div>
                                        )}
                                      </td>
                                    );
                                  })}
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      </section>

                      <section className="bg-yellow-50 border-l-4 border-yellow-200 p-4 rounded-lg mb-6 shadow-sm mt-6">
                        <h2 className="text-xl font-semibold text-yellow-700 flex items-center gap-2 mb-4">
                            <IconInfo className="w-5 h-5 text-yellow-600 mr-2" /> [ สรุป ] คาบสอนแทน
                        </h2>
                        {substituteSummary.length > 0 ? (
                            <div className="overflow-x-auto">
                                <table className="min-w-full table-auto border-collapse bg-white rounded-lg shadow-sm">
                                    <thead className="bg-yellow-100 text-yellow-800 text-sm">
                                        <tr>
                                            <th className="p-3 border border-yellow-200 text-left">ครูสอนแทน</th>
                                            <th className="p-3 border border-yellow-200 text-left">ครูที่ลา</th>
                                            <th className="p-3 border border-yellow-200 text-left">วัน</th>
                                            <th className="p-3 border border-yellow-200 text-center">คาบ</th>
                                            <th className="p-3 border border-yellow-200 text-left">เวลา</th>
                                            <th className="p-3 border border-yellow-200 text-left">วิชา</th>
                                            <th className="p-3 border border-yellow-200 text-left">ห้อง</th>
                                            <th className="p-3 border border-yellow-200 text-left">ห้องเรียน</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {substituteSummary.map((slot, index) => {
                                            const prevSlot = index > 0 ? substituteSummary[index - 1] : null;
                                            const showSubstituteName = !prevSlot || prevSlot.substituteId !== slot.substituteId;
                                            const isNewGroup = showSubstituteName;

                                            return (
                                                <tr key={index} className={`text-sm even:bg-gray-50 hover:bg-yellow-50 ${isNewGroup && index > 0 ? 'border-t-2 border-yellow-400' : ''}`}>
                                                    <td className="p-2 border border-gray-200 font-semibold text-green-700">
                                                        {showSubstituteName ? `${slot.substituteName} (${slot.substituteId})` : ''}
                                                    </td>
                                                    <td className="p-2 border border-gray-200 text-red-600">{slot.absentTeacherName} ({slot.absentTeacherId})</td>
                                                    <td className="p-2 border border-gray-200">{dayNames[slot.dayIndex]}</td>
                                                    <td className="p-2 border border-gray-200 text-center">{slot.periodIndex + 1}</td>
                                                    <td className="p-2 border border-gray-200">{slot.time}</td>
                                                    <td className="p-2 border border-gray-200">{slot.subject}</td>
                                                    <td className="p-2 border border-gray-200">{slot.class}</td>
                                                    <td className="p-2 border border-gray-200">{slot.room}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        ) : (
                            <p className="text-gray-500 text-center py-4">ยังไม่มีข้อมูลการสอนแทน</p>
                        )}
                      </section>
                    </>
                  )}

                  {activeTab === 'full_schedule' && (
                    <section className="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
                        <div className="mb-4">
                            <h2 className="text-xl font-semibold text-blue-700 flex items-center gap-2 whitespace-nowrap">
                                <IconCalendar /> ตารางสอนครู [{filteredTeachers.length}/{teachers.length} คน]
                            </h2>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-2 w-full mb-6">
                            <button
                                onClick={() => { setSelectedTimetableTeacherId(''); setTimetableSearchQuery(''); }}
                                className="px-4 py-2 rounded-xl bg-purple-600 text-white font-medium shadow-sm hover:bg-purple-700 transition-colors duration-200 flex items-center justify-center gap-2"
                            >
                                ทั้งหมด
                            </button>
                            <select
                                value={selectedTimetableTeacherId}
                                onChange={(e) => {
                                  setSelectedTimetableTeacherId(e.target.value);
                                  setTimetableSearchQuery('');
                                }}
                                className="flex-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm appearance-none"
                              >
                                <option value="">--เลือกครู--</option>
                                {teachers.sort((a,b) => a.id.localeCompare(b.id, 'th')).map(teacher => (
                                  <option key={teacher.id} value={teacher.id}>
                                    {teacher.id} - {teacher.name}
                                  </option>
                                ))}
                            </select>
                            <input
                                type="text"
                                placeholder="พิมพ์ชื่อครู"
                                value={timetableSearchQuery}
                                onChange={(e) => {
                                  setTimetableSearchQuery(e.target.value);
                                  setSelectedTimetableTeacherId('');
                                }}
                                className="flex-1 block w-full px-4 py-2 text-base border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                            />
                            <button
                                onClick={handleExportToExcel}
                                className="px-4 py-2 rounded-xl bg-green-600 text-white font-medium shadow-sm hover:bg-green-700 transition-colors duration-200 flex items-center justify-center gap-2"
                                disabled={Object.values(schedule).flat().length === 0}
                            >
                                <IconFileDown className="w-5 h-5" />
                                Export
                            </button>
                        </div>
                        
                        {(filteredTeachers.length === 0) ? (
                          <div className="text-center text-gray-500 py-10">
                            ไม่พบชื่อครูที่คุณค้นหา
                          </div>
                        ) : (
                          filteredTeachers.map(teacher => (
                              <div key={teacher.id} className="mb-8 last:mb-0">
                                  <h3 className="text-lg font-bold text-blue-600 mb-2 p-3 bg-blue-50 rounded-t-xl">
                                      ตารางสอนของ : {teacher.id} - {teacher.name}
                                  </h3>
                                  <div className="overflow-x-auto shadow-md rounded-b-xl">
                                      <table className="min-w-full table-fixed border-collapse">
                                          <thead>
                                              <tr className="bg-blue-100 text-blue-800 font-bold text-sm">
                                                  <th className="p-3 border border-blue-200 w-[15%] text-center sticky left-0 bg-blue-100 z-10">วัน</th>
                                                  {periods.map(period => (
                                                      <th key={period} className="p-3 border border-blue-200 w-[8.5%] text-center">
                                                          คาบที่ {period}
                                                          <p className="text-[10px] font-normal text-blue-600 mt-1">{currentPeriodTimes[period - 1]}</p>
                                                      </th>
                                                  ))}
                                              </tr>
                                          </thead>
                                          <tbody>
                                              {dayNames.map((day, dayIndex) => (
                                                  <tr key={dayIndex} className="text-center text-sm even:bg-gray-50">
                                                      <td className="p-3 border border-gray-200 font-bold bg-blue-50 text-blue-700 sticky left-0 z-10">
                                                          วัน{day}
                                                      </td>
                                                      {periods.map(periodIndex => {
                                                          const slot = getSlot(teacher.id, dayIndex, periodIndex - 1);
                                                          return (
                                                              <td key={`${teacher.id}-${dayIndex}-${periodIndex}`} className={`p-3 border border-gray-200 ${getSlotClass(teacher.id, dayIndex, periodIndex - 1)}`}>
                                                                  {slot && (
                                                                      <div>
                                                                          <p className="font-semibold text-xs sm:text-sm">{slot.subject}</p>
                                                                          <p className="text-[10px] sm:text-xs text-gray-500">{slot.class}</p>
                                                                          <p className="text-[10px] sm:text-xs text-gray-500">{slot.room}</p>
                                                                      </div>
                                                                  )}
                                                              </td>
                                                          );
                                                      })}
                                                  </tr>
                                              ))}
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          ))
                        )}
                    </section>
                  )}
                </main>
                
                {isImportModalOpen && (
                    <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center p-4 z-50">
                        <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl relative">
                            <button onClick={() => setIsImportModalOpen(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><IconX /></button>
                            <section>
                                <div className="flex items-center justify-between mb-4">
                                  <h2 className="text-xl font-semibold text-yellow-700 flex items-center gap-2">
                                    <IconUpload className="text-yellow-700" /> นำเข้าข้อมูลตารางสอน
                                  </h2>
                                </div>
                                <p className="text-gray-600 mb-6">
                                  อัปโหลดไฟล์ Excel (.xlsx, .xls) เพื่อนำเข้าข้อมูลตารางสอนใหม่
                                  <span className="block mt-2 text-sm text-red-600">
                                    คำเตือน: การนำเข้าข้อมูลใหม่จะล้างข้อมูลตารางสอนเดิมทั้งหมด
                                  </span>
                                </p>

                                <div className="bg-yellow-50 border-l-4 border-yellow-200 p-4 rounded-lg mb-6 shadow-sm relative">
                                    <div className="flex items-center mb-2">
                                        <IconInfo className="w-5 h-5 text-yellow-700 stroke-current mr-3" />
                                        <h3 className="font-bold text-yellow-700 text-lg">รายละเอียดหัวข้อไฟล์ Excel</h3>
                                        <button
                                          onClick={handleDownloadSampleFile}
                                          className="absolute top-4 right-4 px-3 py-1 rounded-xl bg-blue-600 text-white font-medium shadow-sm hover:bg-blue-700 transition-colors duration-200 flex items-center justify-center gap-1 text-xs sm:text-sm"
                                        >
                                          <IconFileDown className="w-4 h-4" />
                                          ดาวน์โหลดไฟล์ตัวอย่าง (.xlsx)
                                        </button>
                                    </div>
                                    <p className="text-sm text-yellow-700 mb-4">
                                        1. ต้องมี 8 Column ดังนี้ [ รหัสครู, ชื่อครู , วัน , คาบที่ , เวลา , วิชา, ห้อง , ห้องเรียน ]<br/>
                                        2. ในช่องที่ไม่มีข้อมูล ให้ใส่ " . " (จุด)   เช่น ห้องเรียน วิชาลูกเสือ ของ ครูสมศักดิ์
                                    </p>
                                    <div className="overflow-x-auto">
                                        <table className="min-w-full bg-white rounded-lg border border-gray-200 shadow-sm">
                                            <thead>
                                                <tr className="bg-yellow-100">
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">รหัสครู</th>
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">ชื่อครู</th>
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">วัน</th>
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">คาบที่</th>
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">เวลา</th>
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">วิชา</th>
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">ห้อง</th>
                                                    <th className="p-3 text-sm font-semibold text-yellow-800 border-b-2 border-yellow-200 text-left">ห้องเรียน</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr><td className="p-3 text-sm border-b border-gray-200 font-medium text-gray-700">T001</td><td className="p-3 text-sm border-b border-gray-200 font-medium text-gray-700">ครูสมชาย</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">จันทร์</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">5</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">08:30-09:20</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">คณิตศาสตร์</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">ม.1/1</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">ห้อง 101</td></tr>
                                                <tr className="bg-gray-50"><td className="p-3 text-sm border-b border-gray-200 font-medium text-gray-700">T002</td><td className="p-3 text-sm border-b border-gray-200 font-medium text-gray-700">ครูสมศรี</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">อังคาร</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">2</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">09:20-10:10</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">ภาษาไทย</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">ม.2/2</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">ห้อง 202</td></tr>
                                                <tr><td className="p-3 text-sm border-b border-gray-200 font-medium text-gray-700">T003</td><td className="p-3 text-sm border-b border-gray-200 font-medium text-gray-700">ครูสมศักดิ์</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">พุธ</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">4</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">11:00-11:50</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">ลูกเสือ</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">.</td><td className="p-3 text-sm border-b border-gray-200 text-gray-600">.</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div className="flex flex-col sm:flex-row items-center gap-4 w-full">
  <input 
    id="file-upload-modal"
    type="file" 
    accept=".xlsx, .xls"
    onChange={(e) => {
      const file = e.target.files[0];
      if (file) handleFileImport(file);
    }}
    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
  />

  {importFile && (
    <button 
      onClick={handleClearSelectedFile} 
      className="
        inline-flex 
        items-center 
        justify-center
        p-1 
        border-0 border-red-500 
        bg-transparent 
        text-red-500 
        rounded-full 
        hover:bg-red-500 hover:text-white 
        transition-colors duration-200
        shrink-0
      "
      aria-label="ลบไฟล์"
      title="ลบไฟล์"
    >
      <IconXCircle className="w-6 h-6" />
      <span> ลบไฟล์ </span>
    </button>
  )}
</div>

                                {isImporting && (
                                  <div className="mt-4 text-center text-blue-600 font-medium">
                                    กำลังนำเข้าข้อมูล...
                                  </div>
                                )}
                                {message.text && message.tab === 'import' && message.type === 'error' && (
                                  <div className={`p-4 rounded-lg shadow mt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between animate-fade-in
                                    ${message.type === 'success' ? 'bg-green-100 border-l-4 border-green-500 text-green-700' : 
                                      message.type === 'error' ? 'bg-red-100 border-l-4 border-red-500 text-red-700' :
                                      'bg-blue-100 border-l-4 border-blue-500 text-blue-700'}`}
                                    role="alert"
                                  >
                                    <div className="flex items-center mb-2 sm:mb-0">
                                      {message.type === 'success' ? <IconCheckCircle className="h-5 w-5 mr-3" /> : 
                                       message.type === 'error' ? <IconX className="h-5 w-5 mr-3" /> :
                                       <IconInfo className="w-5 h-5 mr-3" />}
                                      <p className="font-medium">{message.text}</p>
                                    </div>
                                    {message.type === 'error' && message.details && message.details.length > 0 && (
                                      <div className="mt-4 p-3 bg-red-50 rounded-lg border border-red-200 w-full">
                                        <p className="font-semibold text-red-800 mb-2">รายละเอียดข้อผิดพลาด:</p>
                                        <div className="overflow-x-auto">
                                          <table className="min-w-full text-left text-sm text-red-700">
                                            <thead><tr><th className="p-2">แถวที่</th><th className="p-2">เหตุผล</th><th className="p-2">แนวทางแก้ไข</th></tr></thead>
                                            <tbody>
                                              {message.details.map((detail, index) => (
                                                <tr key={index} className="even:bg-red-50"><td className="p-2">{detail.row}</td><td className="p-2">{detail.reason}</td><td className="p-2">{detail.solution}</td></tr>
                                              ))}
                                            </tbody>
                                          </table>
                                        </div>
                                      </div>
                                    )}
                                    <button
                                      onClick={() => setMessage({ type: '', text: '', details: [], tab: '' })}
                                      className={`ml-auto sm:ml-4 p-1 rounded-full transition-colors flex-shrink-0
                                        ${message.type === 'success' ? 'hover:bg-green-200 text-green-600' : 
                                          message.type === 'error' ? 'hover:bg-red-200 text-red-600' :
                                          'hover:bg-blue-200 text-blue-600'}`}
                                      aria-label="Close message"
                                    >
                                      <IconX className="h-4 w-4" />
                                    </button>
                                  </div>
                                )}
                                {importSuccess && (
                                    <div className="flex justify-center">
                                        <button 
                                            onClick={handleFinishImport}
                                            className="px-6 py-2 rounded-xl bg-green-600 text-white font-medium shadow-sm hover:bg-green-700 transition-colors duration-200 flex items-center justify-center gap-2"
                                        >
                                            <IconCheckCircle className="w-5 h-5" />
                                            เสร็จสิ้น
                                        </button>
                                    </div>
                                )}
                            </section>
                        </div>
                    </div>
                  )}

                {isModalOpen && selectedAbsentSlot && (
                  <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-lg relative">
                      <button onClick={() => setIsModalOpen(false)} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><IconX /></button>
                      <h3 className="text-2xl font-bold text-blue-700 mb-4">มอบหมายครูสอนแทน</h3>
                      <div className="bg-gray-100 p-4 rounded-xl mb-4 space-y-1">
                        <p><span className="font-semibold">ครูที่ลา:</span> {getTeacherName(selectedAbsentSlot.teacherId)}</p>
                        <p><span className="font-semibold">วัน:</span> {dayNames[selectedAbsentSlot.dayIndex]}</p>
                        <p><span className="font-semibold">คาบ:</span> {selectedAbsentSlot.periodIndex + 1}</p>
                        <p><span className="font-semibold">เวลา:</span> {selectedAbsentSlot.time || currentPeriodTimes[selectedAbsentSlot.periodIndex]}</p>
                        <p><span className="font-semibold">วิชา:</span> {selectedAbsentSlot.subject}</p>
                        <p><span className="font-semibold">ห้อง:</span> {selectedAbsentSlot.room}</p>
                        {selectedAbsentSlot.substituteId && <p className="pt-2 text-green-600 font-semibold border-t mt-2">ปัจจุบัน: {getTeacherName(selectedAbsentSlot.substituteId)}</p>}
                      </div>
                      
                      <div className="space-y-4">
                        <h4 className="text-lg font-semibold mb-1">เลือกครูสอนแทน:</h4>
                        <p className={`font-semibold mb-2 text-xs ${availableSubstitutes.length > 0 ? 'text-blue-600' : 'text-red-600'}`}>
                          ครูที่ว่างในคาบนี้ = {availableSubstitutes.length} คน
                        </p>
                        <select value={selectedSubstituteId} onChange={(e) => setSelectedSubstituteId(e.target.value)} className="block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                          <option value="">-- เลือกครู --</option>
                          {availableSubstitutes.sort((a,b) => a.name.localeCompare(b.name, 'th')).map(sub => (<option key={sub.id} value={sub.id}>{sub.name}</option>))}
                        </select>

                        <div className="flex justify-end gap-2">
                          {selectedAbsentSlot.substituteId ? (
                              <div className="flex justify-end gap-2">
                                  <button onClick={cancelSubstitute} className="px-4 py-2 rounded-xl text-gray-700 font-medium hover:bg-gray-200">ยกเลิกการสอนแทน</button>
                                  <button onClick={() => assignSubstitute(selectedSubstituteId)} disabled={!selectedSubstituteId} className="px-4 py-2 rounded-xl bg-blue-600 text-white font-medium shadow-sm hover:bg-blue-700 disabled:bg-gray-400">สอนแทน</button>
                              </div>
                          ) : (
                              <div className="flex justify-end gap-2">
                                   <button onClick={() => setIsModalOpen(false)} className="px-4 py-2 rounded-xl text-gray-700 font-medium hover:bg-gray-200">ยกเลิก</button>
                                  <button onClick={() => assignSubstitute(selectedSubstituteId)} disabled={!selectedSubstituteId} className="px-4 py-2 rounded-xl bg-blue-600 text-white font-medium shadow-sm hover:bg-blue-700 disabled:bg-gray-400">สอนแทน</button>
                              </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {isConfirmModalOpen && (
                  <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative">
                      <h3 className="text-xl font-bold text-blue-700 mb-4">ยืนยันการแจ้งขาดสอน</h3>
                      <p className="text-gray-700 mb-6">คุณต้องการแจ้งว่าครู <span className="font-semibold">{getTeacherName(selectedTeacherToReportAbsence)}</span> ขาดสอนใน<span className="font-semibold">วัน{dayNames[selectedDayIndex]}</span> ใช่หรือไม่?</p>
                      <div className="flex justify-end space-x-2">
                        <button onClick={cancelAbsenceAction} className="px-4 py-2 rounded-xl text-gray-700 font-medium hover:bg-gray-200">ยกเลิก</button>
                        <button onClick={confirmAbsenceAction} className="px-4 py-2 rounded-xl bg-red-600 text-white font-medium shadow-sm hover:bg-red-700">ลา</button>
                      </div>
                    </div>
                  </div>
                )}

                {isClearConfirmModalOpen && (
                  <div className="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-center p-4 z-50">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-sm relative">
                      <h3 className="text-xl font-bold text-red-700 mb-4">ยืนยันการลบข้อมูล</h3>
                      <p className="text-gray-700 mb-6">คุณต้องการลบข้อมูลการลาและการมอบหมายครูสอนแทนทั้งหมดใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้</p>
                      <div className="flex justify-end space-x-2">
                        <button onClick={() => setIsClearConfirmModalOpen(false)} className="px-4 py-2 rounded-xl text-gray-700 font-medium hover:bg-gray-200">ยกเลิก</button>
                        <button onClick={handleClearAllData} disabled={isClearing} className="px-4 py-2 rounded-xl bg-red-600 text-white font-medium shadow-sm hover:bg-red-700 disabled:bg-gray-400">{isClearing ? 'กำลังลบ...' : 'ยืนยัน'}</button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Render the App component to the DOM
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</ht
